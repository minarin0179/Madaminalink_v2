name: Update Docs with Claude

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
  workflow_dispatch:
    inputs:
      prompt:
        description: 'è¿½åŠ ã®æŒ‡ç¤ºï¼ˆä»»æ„ï¼‰'
        required: false
        type: string

jobs:
  update-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        if: github.event_name == 'push'
        run: |
          # ç›´å‰ã®ã‚³ãƒŸãƒƒãƒˆã§å¤‰æ›´ã•ã‚ŒãŸsrc/é…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- 'src/**' | tr '\n' ' ')
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "Changed files: $CHANGED_FILES"

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã¯ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼å‘ã‘Discord Botã€Œãƒãƒ€ãƒŸãƒŠãƒªãƒ³ã‚¯ã€ã§ã™ã€‚

            ## ã‚¿ã‚¹ã‚¯
            ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ã‚’ç¢ºèªã—ã€å¯¾å¿œã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆdocs/é…ä¸‹ï¼‰ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚

            ## å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
            ${{ steps.changed-files.outputs.files || 'ã™ã¹ã¦ã®src/é…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„' }}

            ## è¿½åŠ ã®æŒ‡ç¤º
            ${{ inputs.prompt || 'ãªã—' }}

            ## ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å ´æ‰€
            - docs/commands/ - å„ã‚³ãƒãƒ³ãƒ‰ã®è©³ç´°ãƒšãƒ¼ã‚¸
            - docs/guide/ - å°å…¥ã‚¬ã‚¤ãƒ‰
            - docs/index.md - ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸
            - docs/.vitepress/config.{mts,ts,js,mjs} - ã‚µã‚¤ãƒ‰ãƒãƒ¼è¨­å®šï¼ˆæ–°è¦ãƒšãƒ¼ã‚¸è¿½åŠ æ™‚ã¯æ›´æ–°ãŒå¿…è¦ï¼‰

            ## ä½œæ¥­æ‰‹é †
            1. å¤‰æ›´ã•ã‚ŒãŸã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§ã€ã©ã®ã‚ˆã†ãªæ©Ÿèƒ½å¤‰æ›´ãŒã‚ã£ãŸã‹ç†è§£ã™ã‚‹
            2. å¯¾å¿œã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
            3. å­˜åœ¨ã—ãªã„å ´åˆã¯ docs/commands/_template.md ã‚’å‚è€ƒã«æ–°è¦ä½œæˆ
            4. å­˜åœ¨ã™ã‚‹å ´åˆã¯å†…å®¹ã‚’æ›´æ–°
            5. æ–°è¦ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã—ãŸå ´åˆã¯ docs/.vitepress/config.mts ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ã‚‚è¿½åŠ 

            ## æ³¨æ„äº‹é …
            - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯æ—¥æœ¬èªã§æ›¸ã„ã¦ãã ã•ã„
            - VitePressã®Markdownè¨˜æ³•ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
            - ã‚³ãƒãƒ³ãƒ‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€ä½¿ç”¨ä¾‹ã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’å«ã‚ã¦ãã ã•ã„
            - å¤‰æ›´ãŒãªã„å ´åˆã‚„ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ãŒä¸è¦ãªå ´åˆã¯ä½•ã‚‚ã—ãªã„ã§ãã ã•ã„
          claude_args: |
            --allowedTools Edit,Write,Read,Glob,Grep,Bash(git diff:*),Bash(git log:*),Bash(git show:*)
            --max-turns 30

      - name: Create Pull Request
        if: steps.claude.outputs.conclusion == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ -z $(git status --porcelain) ]]; then
            echo "No changes to commit"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH_NAME="docs/auto-update-${{ github.run_number }}"
          git checkout -b "$BRANCH_NAME"
          git add docs/
          git commit -m "docs: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è‡ªå‹•æ›´æ–°"
          git push -u origin "$BRANCH_NAME"

          gh pr create --title "docs: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è‡ªå‹•æ›´æ–°" --body "ğŸ¤– Generated by Claude Code Action" --draft
