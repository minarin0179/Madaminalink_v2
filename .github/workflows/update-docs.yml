name: Update Docs with Claude

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
  workflow_dispatch:
    inputs:
      prompt:
        description: '追加の指示（任意）'
        required: false
        type: string

jobs:
  update-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        if: github.event_name == 'push'
        run: |
          # 直前のコミットで変更されたsrc/配下のファイルを取得
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- 'src/**' | tr '\n' ' ')
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "Changed files: $CHANGED_FILES"

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            このリポジトリはマーダーミステリー向けDiscord Bot「マダミナリンク」です。

            ## タスク
            ソースコードの変更を確認し、対応するドキュメント（docs/配下）を更新してください。

            ## 変更されたファイル
            ${{ steps.changed-files.outputs.files || 'すべてのsrc/配下のファイルを確認してください' }}

            ## 追加の指示
            ${{ inputs.prompt || 'なし' }}

            ## ドキュメントの場所
            - docs/commands/ - 各コマンドの詳細ページ
            - docs/guide/ - 導入ガイド
            - docs/index.md - トップページ
            - docs/.vitepress/config.{mts,ts,js,mjs} - サイドバー設定（新規ページ追加時は更新が必要）

            ## 作業手順
            1. 変更されたソースコードを読んで、どのような機能変更があったか理解する
            2. 対応するドキュメントファイルが存在するか確認
            3. 存在しない場合は docs/commands/_template.md を参考に新規作成
            4. 存在する場合は内容を更新
            5. 新規ページを作成した場合は docs/.vitepress/config.mts のサイドバーにも追加

            ## 注意事項
            - ドキュメントは日本語で書いてください
            - VitePressのMarkdown記法を使用してください
            - コマンドのオプション、使用例、ユースケースを含めてください
            - 変更がない場合や、ドキュメント更新が不要な場合は何もしないでください
          allowed_tools: "Edit,Write,Read,Glob,Grep,Bash(git diff:*),Bash(git log:*),Bash(git show:*)"
          timeout_minutes: 30

      - name: Create Pull Request
        if: steps.claude.outputs.conclusion == 'success'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: ドキュメントを自動更新"
          title: "docs: ドキュメントを自動更新"
          body: |
            ## 概要
            Claudeがソースコードの変更を検出し、ドキュメントを自動更新しました。

            ## 確認事項
            - [ ] 内容が正確か確認
            - [ ] 日本語の文章が自然か確認
            - [ ] リンクが正しいか確認

            ---
            🤖 Generated by Claude Code Action
          branch: docs/auto-update-${{ github.run_number }}
          base: main
          draft: true
          labels: documentation,automated
